//import schema from './EMRALD_JsonSchemaV3_0.json';
import { Validator } from 'jsonschema';
import { UpgradeReturn } from '../v1_x/UpgradeV1_x'
import { Event as EventV2_4 } from '../v2_4/AllModelInterfacesV2_4'
import { EMRALD_Model as EMRALD_ModelV2_4 } from '../v2_4/AllModelInterfacesV2_4'
import { DiagramType as DiagramTypeV2_4 } from '../v2_4/AllModelInterfacesV2_4'
import { Diagram as DiagramV2_4 } from '../v2_4/AllModelInterfacesV2_4'
import { LogicNode as LogicNodeV2_4 } from '../v2_4/AllModelInterfacesV2_4'

import { Event } from './AllModelInterfacesV3_0'
import { EMRALD_Model } from './AllModelInterfacesV3_0'
import { EventType } from './AllModelInterfacesV3_0'
import { DiagramType, GeometryInfo } from './AllModelInterfacesV3_0'
import { LogicNode } from './AllModelInterfacesV3_0'
import { State } from './AllModelInterfacesV3_0'
import { Diagram } from './AllModelInterfacesV3_0'
import { StateEvalValue } from './AllModelInterfacesV3_0'
import { Upgrade } from '../upgrade';



export function UpgradeV3_0(modelTxt: string): UpgradeReturn {
    //var m : EMRALD_ModelV2_4;
    var oldModel: EMRALD_ModelV2_4 = JSON.parse(modelTxt);
    
    //do upgrade steps for version change 2.4 to 3.0
    //remove the extra layer between all the lists so we dont have items like - "EventList" : { "Event": {...}, "Event": {...}}
    const newModel: EMRALD_Model = {
        ...oldModel,
        DiagramList: oldModel.DiagramList ? oldModel.DiagramList.map(({ Diagram }) => {
            const { diagramList, forceMerge, singleStates, ...rest } = Diagram; //exclude diagramList, forceMerge, singleStates
            return {
                ...rest, // Spread the rest of the properties
                diagramType: mapDiagramType(Diagram.diagramType) // Add the mapped diagramType
            };
        }) : [],
        ExtSimList: oldModel.ExtSimList ? oldModel.ExtSimList.map(({ ExtSim }) => {
            const { modelRef, states, configData, simMaxTime, varScope, value, resetOnRuns, type, sim3DId, ...rest } = ExtSim; //exclude
            return rest;
        }) : [],
        // StateList: oldModel.StateList ? oldModel.StateList.map(({ State }) => ({ ...State })) : [],
        StateList: oldModel.StateList ? oldModel.StateList.map(({ State }) => {
            const correctedString = State.geometry
            .replace(/([a-zA-Z0-9]+)\s*:/g, '"$1":') // Replace property names with double quotes
            .replace(/'/g, '"'); // Replace single quotes with double quotes
            const parsedGeometry = JSON.parse(correctedString);
            var geometryInfo: GeometryInfo = parsedGeometry;
            const { geometry, ...rest } = State; //exclude geometry
            return {
                ...rest,
                geometryInfo
            };
        }) : [],
        ActionList: oldModel.ActionList ? oldModel.ActionList.map(({ Action }) => {
            const { itemId, moveFromCurrent, ...rest } = Action; //exclude itemId and move from current
            var mainItem : boolean = Action.mainItem ? Action.mainItem : false;
            return {
                ...rest,
                mainItem
            };
        }) : [],
        EventList: oldModel.EventList ? oldModel.EventList.map(({ Event }) => {
            const {...rest } = Event;
            var ifInState : boolean | undefined = Event.ifInState != null ?
                (typeof Event.ifInState === 'string' ? Event.ifInState.toUpperCase() === 'TRUE' : Event.ifInState) :
                undefined;
            return {
                ...rest,
                ifInState
            };

        }) : [],
        LogicNodeList: oldModel.LogicNodeList ? oldModel.LogicNodeList.map(({ LogicNode }) => ({
            ...LogicNode,
            isRoot: LogicNode.isRoot !== undefined ? LogicNode.isRoot : false,
            compChildren: mapLogicNode(LogicNode.compChildren)
        })): [],
        VariableList: oldModel.VariableList ? oldModel.VariableList.map(({ Variable }) => {
            // Destructure Variable, excluding modelRef, states, configData, and simMaxTime
            const { modelRef=null, states, configData, simMaxTime, $$hashKey, ...rest } = Variable;
            
            var regExpLine : number | undefined = undefined;
            if (Variable.regExpLine !== undefined){
                if(typeof Variable.regExpLine === 'string')
                    regExpLine = parseFloat(Variable.regExpLine);
                else
                    regExpLine = Variable.regExpLine;                
            }

            var begPosition : number | undefined = undefined;
            if (Variable.begPosition !== undefined){
                if(typeof Variable.begPosition === 'string')
                    begPosition = parseFloat(Variable.begPosition);
                else
                begPosition = Variable.begPosition;
            }

            
            // Map accrualStatesData if it's defined
            const accrualStatesData = Variable.accrualStatesData === undefined ? undefined :
            Variable.accrualStatesData.map( AccrualState  => {
                // Destructure AccrualState, excluding $$hashKey
                const { $$hashKey, ...rest } = AccrualState;
                return rest;
            });
        
            return {
                ...rest, // Spread the rest of the properties
                accrualStatesData, // Include mapped accrualStatesData
                regExpLine,
                begPosition
            };
        }) : []
    }


    //function to map changed diagram type
    function mapLogicNode(childNames: string[]) {
        //move the child name to the diagramName and create an empty stateValues array.
        return childNames ? childNames.map(child => ({ diagramName: child, stateValues: [] })) : [];
    }

    //function to map changed diagram type
    function mapDiagramType(diagramType: DiagramTypeV2_4): DiagramType {
        switch (diagramType) {
            case "dtComponent":
            case "dtSystem":
                return "dtSingle";
            default:
                return "dtMulti";
        }
    }

    //Assign the state default values 
    //type D2 = DiagramV2_4;
    const oldDiagrams: DiagramV2_4[] = oldModel.DiagramList ? oldModel.DiagramList.map(({ Diagram }) => ({ ...Diagram })) : [];

    const stateValDict = new Map<string, StateEvalValue>(); //values for states
    const singleDiagrams = new Set<string>();
    oldDiagrams.forEach((diagram: DiagramV2_4) => {
        //find all the state values for diagrams that are single state diagrams
        if (diagram.singleStates !== undefined) {
            diagram.singleStates.forEach((value: { stateName: string; okState: "True" | "False" }) => {
                stateValDict.set(value.stateName, (value.okState === "True") ? "True" : "False");
            });
            singleDiagrams.add(diagram.name);
        }
    });

    newModel.StateList.forEach(state => {
        if (singleDiagrams.has(state.diagramName)) {
            if (stateValDict.has(state.name)) {
                state.defaultSingleStateValue = stateValDict.get(state.name);
            }
            else {
                state.defaultSingleStateValue = "Ignore";
            }
        }
    });

    newModel.version = 3.0;
    const retModel: UpgradeReturn = { newModel: JSON.stringify(newModel), errors: [] };

    //to validate the new version against the schema
    const schemaPath = './src/utils/Upgrades/v3_0/EMRALD_JsonSchemaV3_0.json';
    // const schemaTxt = fs.readFileSync(schemaPath, 'utf-8').trim();    
    
    const schemaTxt2 = "{\r\n    \"$schema\": \"http:\/\/json-schema.org\/draft-07\/schema#\",\r\n    \"type\": \"object\",\r\n    \"title\": \"EMRALD_Model\",\r\n    \"description\": \"EMRALD model schema version 2.4\",\r\n    \"properties\": {\r\n        \"id\": {\r\n            \"type\": \"integer\",\r\n            \"description\": \"Temporary, only used internally for some identification or uniqueness needs\"\r\n        },\r\n        \"name\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Name of the EMRALD model\"\r\n        },\r\n        \"desc\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"description of the EMRALD model\"\r\n        },\r\n        \"version\": {\r\n            \"type\": \"number\",\r\n            \"description\": \"Version of the EMRALD model\"\r\n        },\r\n        \"DiagramList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the diagrams for the model\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/Diagram\"\r\n            }\r\n        },\r\n        \"ExtSimList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the external simulation links for the mdoel\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/ExtSim\"\r\n            }\r\n        },\r\n        \"StateList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All of the states for the different diagrams of the model\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/State\"\r\n            }\r\n        },\r\n        \"ActionList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the actions that can be used in the model\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/Action\"\r\n            }\r\n        },\r\n        \"EventList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the events that are used in the model.\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/Event\"\r\n            }\r\n        },\r\n        \"LogicNodeList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the logic nodes to make the logic trees in the model\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/LogicNode\"\r\n            }\r\n        },\r\n        \"VariableList\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"All the variables used in the model\",\r\n            \"items\": {\r\n                \"$ref\": \"#\/definitions\/Variable\"\r\n            }\r\n        },\r\n        \"templates\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"Templates avaliable to make new diagrams in the model. These are basicly a small model all on there own.\",\r\n            \"items\": {}\r\n        },\r\n        \"changeLog\": {\r\n            \"$ref\": \"#\/definitions\/ChangeLog\"\r\n        }\r\n    },\r\n    \"additionalProperties\": false,\r\n    \"required\": [\r\n        \"name\",\r\n        \"desc\",\r\n        \"version\",\r\n        \"DiagramList\",\r\n        \"ExtSimList\",\r\n        \"StateList\",\r\n        \"ActionList\",\r\n        \"EventList\",\r\n        \"LogicNodeList\",\r\n        \"VariableList\"\r\n    ],\r\n    \"definitions\": {\r\n        \"Diagram\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional. Only used for internal processing needs.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Name of the diagram\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"description of the diagram\"\r\n                },\r\n                \"diagramType\": {\r\n                    \"$ref\": \"#\/definitions\/DiagramType\"\r\n                },\r\n                \"diagramTemplate\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"name of template used to make this diagram\"\r\n                },\r\n                \"diagramLabel\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Name of grouping in the UI for this diagram\"\r\n                },\r\n                \"states\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Names of the states used in this diagram\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"desc\",\r\n                \"diagramType\",\r\n                \"diagramLabel\",\r\n                \"states\"\r\n            ]\r\n        },\r\n        \"ExtSim\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional, internal use only.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the model for the external simulation\"\r\n                },\r\n                \"resourceName\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"name of resource type to connect to in MsgServer, not unique if more than one simulation of the same tool\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"resourceName\"\r\n            ]\r\n        },\r\n        \"State\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the model for state\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"User entered description of the state\"\r\n                },\r\n                \"stateType\": {\r\n                    \"$ref\": \"#\/definitions\/StateType\"\r\n                },\r\n                \"diagramName\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Diagram the state belongs to, A state can only be in one diagram.\"\r\n                },\r\n                \"immediateActions\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Array of name references for the immediate actions to be run when entering the state\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"events\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Array of name references to events. These event will be monitored for when in this state.\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"eventActions\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"actions for the events in sibling \\\"events\\\" array. One to one relationship.\",\r\n                    \"items\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"actions\": {\r\n                                \"type\": \"array\",\r\n                                \"description\": \"array of referenace names for actions of the associated event.\",\r\n                                \"items\": {\r\n                                    \"type\": \"string\"\r\n                                }\r\n                            },\r\n                            \"moveFromCurrent\": {\r\n                                \"type\": \"boolean\"\r\n                            }\r\n                        },\r\n                        \"additionalProperties\": false,\r\n                        \"required\": [\r\n                            \"actions\",\r\n                            \"moveFromCurrent\"\r\n                        ]\r\n                    }\r\n                },\r\n                \"geometry\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"possition for the GUI\"\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                },\r\n                \"defaultSingleStateValue\": {\r\n                    \"$ref\": \"#\/definitions\/StateEvalValue\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"desc\",\r\n                \"stateType\",\r\n                \"diagramName\",\r\n                \"immediateActions\",\r\n                \"events\",\r\n                \"eventActions\"\r\n            ]\r\n        },\r\n        \"Action\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional, internal use only.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the model for the action\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"User entered description of the action\"\r\n                },\r\n                \"actType\": {\r\n                    \"$ref\": \"#\/definitions\/ActionType\"\r\n                },\r\n                \"mainItem\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Is this a global item to show up in the global list, If false it showes up in local or all list.\"\r\n                },\r\n                \"mutExcl\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. Only one action may be taken so the probability determines if this action is taken vs another in the EventAction list. If false then the probability is used to sample if this action occured and multiple or no actions could happen when the event is triggered.\"\r\n                },\r\n                \"newStates\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional. If this is a transition action then these are the states that it could be transitioned to.\",\r\n                    \"items\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"toState\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"reference name of the state to transtion to.\"\r\n                            },\r\n                            \"prob\": {\r\n                                \"type\": \"number\",\r\n                                \"description\": \"probability that this state will be transtioned to.\"\r\n                            },\r\n                            \"failDesc\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"The description from the user for output if tthis transition takes place.\"\r\n                            },\r\n                            \"varProb\": {\r\n                                \"type\": [\r\n                                    \"null\",\r\n                                    \"string\"\r\n                                ],\r\n                                \"description\": \"Optional, if used  then the a variable is used for the probability. This is the name of that variable\"\r\n                            }\r\n                        },\r\n                        \"additionalProperties\": false,\r\n                        \"required\": [\r\n                            \"toState\",\r\n                            \"prob\",\r\n                            \"failDesc\"\r\n                        ]\r\n                    }\r\n                },\r\n                \"scriptCode\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optionsl. Script code to be executed if the action type has a script\"\r\n                },\r\n                \"variableName\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For change var value actions, the result of the script is assigned to this variable name reference.\"\r\n                },\r\n                \"codeVariables\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional. If action has a script, these are the variable name references for variables used in the script. All variables used in script must be in this list.\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"sim3DMessage\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg, this is the message to be sent to the coupled external simulation.\"\r\n                },\r\n                \"extSim\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg, this is the name of the coupled external sim to send the message to.\"\r\n                },\r\n                \"sim3DVariable\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg and a sim3DMessage of atCompModify, this is the name of the variable in the external simulation to be modified by the message.\"\r\n                },\r\n                \"openSimVarParams\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg with a sim3DMessage of type atOpenSim, this flag indicates that the JSON has the properties for sim3DModelRef, sim3DConfigData, and simEndTime.\"\r\n                },\r\n                \"sim3DModelRef\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg with a sim3DMessage of type atOpenSim, this is the data defined by the user that is used by the external simulation on startup. Typically a path to a model it need to open.\"\r\n                },\r\n                \"sim3DConfigData\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg with a sim3DMessage of type atOpenSim, this is the data defined by the user that is used by the external simulation on startup.\"\r\n                },\r\n                \"simEndTime\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type at3DSimMsg with a sim3DMessage of type atOpenSim, this is the end simulation time defined by the user that is used by the external simulation on startup.\"\r\n                },\r\n                \"makeInputFileCode\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type atRunExtApp. It is the C# script to be executed and the result strig  passed as a parameter to the executable to be run.\"\r\n                },\r\n                \"exePath\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type atRunExtApp. It is the path of the exe to be run. It can be relative to the location of the EMRALD model.\"\r\n                },\r\n                \"processOutputFileCode\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type atRunExtApp. It is the C# script to be executed after the accociated exe is ran. Typically it reads a result file and script typically returns a string list with +\/-[StateName] to shift out or into a state because of the results..\"\r\n                },\r\n                \"formData\": {\r\n                    \"description\": \"Used for executing applications with custom form data. This can be anything needed by the custom form, but in the end only the standard atRunExtApp fields are used to do the action.\"\r\n                },\r\n                \"template\": {\r\n                    \"type\": \"object\",\r\n                    \"description\": \"Optional. For action type atRunExtApp. It is used for custom app form.\"\r\n                },\r\n                \"returnProcess\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For action type atRunExtApp. It is flag to indicate the type of return from the processOutputFileCode. If rtNone then it has no return, othrwise the C# script must return a List<string> with +\/-[StateName] to shift out or into a state.\"\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                },\r\n                \"raType\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"String for the run application action, only for UI used. Options depend on the custom UI forms made. \\\"code\\\" means default user defined pre and post execution code is used.\"\r\n                },\r\n                \"updateVariables\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Used for custom form, variables used in the form.\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"desc\",\r\n                \"actType\",\r\n                \"mainItem\"\r\n            ]\r\n        },\r\n        \"Event\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional, internal use only.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the event in the model.\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"User entered description of the event.\"\r\n                },\r\n                \"mainItem\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Is this a global item to show up in the global list, If false it showes up in local or all list.\"\r\n                },\r\n                \"evType\": {\r\n                    \"$ref\": \"#\/definitions\/EventType\"\r\n                },\r\n                \"allItems\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. For event type etStateCng. Flag to indicate if all the items in the triggerStates need to occure as specified or just one of them.\"\r\n                },\r\n                \"triggerStates\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional. For event type etStateCng. List of state name references as part of the criteria needed to trigger the event. These are the states that need to be entered or exited to tirgger the event.\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"moveFromCurrent\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Depricated, This is stored in the states eventActions property.\"\r\n                },\r\n                \"varNames\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional, Name references for all variables used in scripts if the event type uses scripts.\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"ifInState\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. For event type etStateCng, flag to indicate that event is triggired when entering or exiting states listed in triggerStates array. On Enter State\/s or On Exit State\/s\"\r\n                },\r\n                \"onSuccess\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. For event type etStateCng, flag to indicate that event is triggering needs all the items or just one or rmore from the states listed in triggerStates array. checkbox - All Items\"\r\n                },\r\n                \"triggerOnFalse\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. For event type etComponentLogic, flag to indicate that event is triggered if logic tree evaluates to a False, otherwise it triggeres on true.\"\r\n                },\r\n                \"logicTop\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For event type etComponentLogic, this is the logic tree name to be evaluated for triggering the event.\"\r\n                },\r\n                \"lambda\": {\r\n                    \"description\": \"Optional. Parameter for a event with type of etFailRate. It is either a number or the name of a variable if useVariable is true\",\r\n                    \"anyOf\": [\r\n                        {\r\n                            \"type\": \"string\"\r\n                        },\r\n                        {\r\n                            \"type\": \"number\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"lambdaTimeRate\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. arameter for a event with type of etFailRate. It is the lambda value time frequency.\"\r\n                },\r\n                \"useVariable\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional. Indicates that variables can be used for the fields\"\r\n                },\r\n                \"onVarChange\": {\r\n                    \"$ref\": \"#\/definitions\/VarChangeOptions\"\r\n                },\r\n                \"time\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional, For events of type etTimer. This is a time or variable that indicates the time for the event.\"\r\n                },\r\n                \"timeVariableUnit\": {\r\n                    \"$ref\": \"#\/definitions\/TimeVariableUnit\"\r\n                },\r\n                \"fromSimStart\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional, For time based events, is the time from the beginning of the simulation [true] or from when the state was entered.\"\r\n                },\r\n                \"extEventType\": {\r\n                    \"$ref\": \"#\/definitions\/ExtEventMsgType\"\r\n                },\r\n                \"variable\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For event type et3dSimEv and extEventType etCompEv. It is the reference name for the variable. If that variable is modified by the external code, then the script is executed to determine if the event is triggered.\"\r\n                },\r\n                \"code\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For event type et3dSimEv and extEventType etCompEv. It is the reference name for the variable. If that variable is modified by the external code, then this code script is executed to determine if the event is triggered.\"\r\n                },\r\n                \"distType\": {\r\n                    \"$ref\": \"#\/definitions\/DistributionType\"\r\n                },\r\n                \"parameters\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional. For event type of etDistribution this is an array of properties for the distribution calculation.\",\r\n                    \"items\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"name\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"For event type of etDistribution this is the name of the distribution parameter.\",\r\n                                \"enum\": [\r\n                                    \"Mean\",\r\n                                    \"Standard Deviation\",\r\n                                    \"Minimum\",\r\n                                    \"Maximum\",\r\n                                    \"Rate\",\r\n                                    \"Shape\",\r\n                                    \"Scale\",\r\n                                    \"Peak\",\r\n                                    \"Alpha\",\r\n                                    \"Beta\"\r\n                                ]\r\n                            },\r\n                            \"value\": {\r\n                                \"description\": \"Optional. The value of the parameter if the useVariable flag is false. Can be a number or a string if in scientific notation.\",\r\n                                \"anyOf\": [\r\n                                    {\r\n                                        \"type\": \"number\"\r\n                                    },\r\n                                    {\r\n                                        \"type\": \"string\"\r\n                                    }\r\n                                ]\r\n                            },\r\n                            \"timeRate\": {\r\n                                \"$ref\": \"#\/definitions\/TimeVariableUnit\"\r\n                            },\r\n                            \"useVariable\": {\r\n                                \"type\": \"boolean\",\r\n                                \"description\": \"Flag to use the variable string vs the value item for the property\"\r\n                            },\r\n                            \"variable\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"Optional. The reference name of the variable to use as the value of the parameter if the useVariable flag is true.\"\r\n                            }\r\n                        },\r\n                        \"additionalProperties\": false,\r\n                        \"required\": []\r\n                    }\r\n                },\r\n                \"dfltTimeRate\": {\r\n                    \"$ref\": \"#\/definitions\/TimeVariableUnit\"\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"desc\",\r\n                \"mainItem\",\r\n                \"evType\"\r\n            ]\r\n        },\r\n        \"LogicNode\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional, internal use only.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the logic node\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"User entered description of the logic node\"\r\n                },\r\n                \"gateType\": {\r\n                    \"$ref\": \"#\/definitions\/GateType\"\r\n                },\r\n                \"rootName\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Depricated, dont use\"\r\n                },\r\n                \"compChildren\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Array of component diagram names and state values to use in evaluating if not using the default value.\",\r\n                    \"items\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"stateValues\": {\r\n                                \"type\": \"array\",\r\n                                \"description\": \"Evaluate value if not the states default.\",\r\n                                \"items\": {\r\n                                    \"type\": \"object\",\r\n                                    \"properties\": {\r\n                                        \"stateName\": {\r\n                                            \"type\": \"string\",\r\n                                            \"description\": \"State name for the value.\"\r\n                                        },\r\n                                        \"stateValue\": {\r\n                                            \"$ref\": \"#\/definitions\/StateEvalValue\"\r\n                                        }\r\n                                    },\r\n                                    \"additionalProperties\": false,\r\n                                    \"required\": [\r\n                                        \"stateName\",\r\n                                        \"stateValue\"\r\n                                    ]\r\n                                }\r\n                            },\r\n                            \"diagramName\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"Name of the diagram to be evaluated\"\r\n                            }\r\n                        },\r\n                        \"additionalProperties\": false,\r\n                        \"required\": [\r\n                            \"diagramName\"\r\n                        ]\r\n                    }\r\n                },\r\n                \"gateChildren\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Array of logic node names that are children of this gate.\",\r\n                    \"items\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"isRoot\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Flag indicating that this is to be displayed as a tree top in the UI and can be used in an evaluate logic tree event.\"\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"desc\",\r\n                \"gateType\",\r\n                \"compChildren\",\r\n                \"gateChildren\",\r\n                \"isRoot\"\r\n            ]\r\n        },\r\n        \"Variable\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"id\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional, internal use only.\"\r\n                },\r\n                \"name\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"referenace name in the model for the variable\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"User entered description of the variable\"\r\n                },\r\n                \"varScope\": {\r\n                    \"$ref\": \"#\/definitions\/VarScope\"\r\n                },\r\n                \"value\": {\r\n                    \"description\": \"The default value for the variable.\",\r\n                    \"anyOf\": [\r\n                        {\r\n                            \"type\": \"number\"\r\n                        },\r\n                        {\r\n                            \"type\": \"string\"\r\n                        },\r\n                        {\r\n                            \"type\": \"boolean\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"docLink\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"If the varScope is gtDocLink then this is the expression defining path in the document to the variable is linked to. XPath for XML, JSONPath for JSON, or a RegularExpression for txt\"\r\n                },\r\n                \"docType\": {\r\n                    \"$ref\": \"#\/definitions\/DocVarType\"\r\n                },\r\n                \"docPath\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"If the varScope is gtDocLink then this is the path to the document the variable is linked to.\"\r\n                },\r\n                \"pathMustExist\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Flag, if true then the file in the docPath must exist when the simulation starts running. This is helpful to minimize errors.\"\r\n                },\r\n                \"type\": {\r\n                    \"$ref\": \"#\/definitions\/VariableType\"\r\n                },\r\n                \"accrualStatesData\": {\r\n                    \"type\": \"array\",\r\n                    \"description\": \"Optional. If the variable varScope is gtAccrual, then these are the states used for calculating the variables value over time.\",\r\n                    \"items\": {\r\n                        \"type\": \"object\",\r\n                        \"properties\": {\r\n                            \"stateName\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"Reference name to the state contributiong to the accrual calculation.\"\r\n                            },\r\n                            \"type\": {\r\n                                \"$ref\": \"#\/definitions\/AccrualVarTableType\"\r\n                            },\r\n                            \"accrualMult\": {\r\n                                \"type\": \"number\",\r\n                                \"description\": \"Optional. If type is ctMultiplier then this is the multiplier value for every time increment, specified by the multRate, spent in the state.\"\r\n                            },\r\n                            \"multRate\": {\r\n                                \"type\": \"string\",\r\n                                \"description\": \"This is the time rate for the accrualMult in calculating the value for the variable.\"\r\n                            },\r\n                            \"accrualTable\": {\r\n                                \"type\": \"array\",\r\n                                \"description\": \"Optional. If the type is ctTable then this is the array of values used in calculating this states contribution to the variable value. Example for the first hour the accrual multiplier is 0.5, for the second hour the accrual multiplier is 0.1\",\r\n                                \"items\": {\r\n                                    \"type\": \"array\",\r\n                                    \"description\": \"Each row has the rate the time specified. First value is rate, second value is time.\",\r\n                                    \"items\": {\r\n                                        \"type\": \"integer\",\r\n                                        \"description\": \"First value is rate, send value is for how much time\"\r\n                                    }\r\n                                }\r\n                            }\r\n                        },\r\n                        \"additionalProperties\": false,\r\n                        \"required\": [\r\n                            \"stateName\",\r\n                            \"type\",\r\n                            \"accrualMult\",\r\n                            \"multRate\",\r\n                            \"accrualTable\"\r\n                        ]\r\n                    }\r\n                },\r\n                \"regExpLine\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional. For variable varScope of gtDocLink, docType dtTxtRegExp, this is the regular expression string.\"\r\n                },\r\n                \"begPosition\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional. For variable varScope of gtDocLink, docType dtTxtRegExp, this the start possition after the regular expression finds its match for reading or writing the value of the variable.\"\r\n                },\r\n                \"numChars\": {\r\n                    \"type\": \"integer\",\r\n                    \"description\": \"Optional. For variable varScope of gtDocLink, docType dtTxtRegExp, this how many characters to read for the value of the variable\"\r\n                },\r\n                \"resetOnRuns\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Optional, this specifies if the value of the variable is to be reset to the default value on each run or retain the value from the last run.\"\r\n                },\r\n                \"resourceName\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. If the variable varScope is gt3DSim, this is the name reference to the external simulation to link to for the value.\"\r\n                },\r\n                \"sim3DId\": {\r\n                    \"type\": \"string\",\r\n                    \"description\": \"Optional. For variables of varScope gt3DSim, this is the external simulations name of the variable. It is used in sending a message to the external simulation.\"\r\n                },\r\n                \"changeLog\": {\r\n                    \"$ref\": \"#\/definitions\/ChangeLog\"\r\n                },\r\n                \"cumulativeStats\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Flag to indicate the user want to do cumulative statistics in the results.\"\r\n                },\r\n                \"monitorInSim\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Flag to have the monitor variable check box checked in the solver by default. \"\r\n                },\r\n                \"canMonitor\": {\r\n                    \"type\": \"boolean\",\r\n                    \"description\": \"Flag to indicate if the variable can be monitored in the solver. This removes it from the solver UI if false. Must be true if monitorInSim is true.\"\r\n                }\r\n            },\r\n            \"additionalProperties\": false,\r\n            \"required\": [\r\n                \"name\",\r\n                \"varScope\",\r\n                \"value\",\r\n                \"type\"\r\n            ]\r\n        },\r\n        \"ChangeLog\": {\r\n            \"type\": \"array\",\r\n            \"description\": \"Type of the diagram.\",\r\n            \"items\": {\r\n                \"type\": \"object\",\r\n                \"properties\": {\r\n                    \"cngDesc\": {\r\n                        \"type\": \"string\",\r\n                        \"description\": \"Description of the change.\"\r\n                    },\r\n                    \"dateTime\": {\r\n                        \"type\": \"string\",\r\n                        \"description\": \"ISO 8601 date time format for the change\",\r\n                        \"format\": \"date-time\"\r\n                    },\r\n                    \"cngID\": {\r\n                        \"type\": \"string\"\r\n                    }\r\n                },\r\n                \"additionalProperties\": false,\r\n                \"required\": [\r\n                    \"cngDesc\",\r\n                    \"dateTime\"\r\n                ]\r\n            }\r\n        },\r\n        \"DiagramType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Type of the diagram. dtSingle - means you can only be in one state of the diagram at a time and states evaluate to a value. dtMulti - means you can be in multiple states at a time, but cant evaluate the diagram\",\r\n            \"enum\": [\r\n                \"dtSingle\",\r\n                \"dtMulti\"\r\n            ]\r\n        },\r\n        \"StateType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Type of the state\",\r\n            \"enum\": [\r\n                \"stStart\",\r\n                \"stKeyState\",\r\n                \"stStandard\",\r\n                \"stTerminal\"\r\n            ]\r\n        },\r\n        \"ActionType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"The type of action\",\r\n            \"enum\": [\r\n                \"atTransition\",\r\n                \"atCngVarVal\",\r\n                \"at3DSimMsg\",\r\n                \"atRunExtApp\"\r\n            ]\r\n        },\r\n        \"EventType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Type of the event\",\r\n            \"enum\": [\r\n                \"etStateCng\",\r\n                \"etComponentLogic\",\r\n                \"etFailRate\",\r\n                \"etTimer\",\r\n                \"et3dSimEv\",\r\n                \"etDistribution\",\r\n                \"etVarCond\"\r\n            ]\r\n        },\r\n        \"VarChangeOptions\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Optional. When an event uses a variable and that variable changes, this tells the code how to update the event.\",\r\n            \"enum\": [\r\n                \"ocIgnore\",\r\n                \"ocResample\",\r\n                \"ocAdjust\"\r\n            ]\r\n        },\r\n        \"TimeVariableUnit\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Optional, For events of type etTimer. This is a time unit if a variable is used for the time. Example X min.\",\r\n            \"enum\": [\r\n                \"\",\r\n                \"trYears\",\r\n                \"trDays\",\r\n                \"trHours\",\r\n                \"trMinutes\",\r\n                \"trSeconds\"\r\n            ]\r\n        },\r\n        \"ExtEventMsgType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Optional. For events of type et3dSimEv. This the type of message being sent to the external simulation. See the external messeage JSON schema.\",\r\n            \"enum\": [\r\n                \"etCompEv\",\r\n                \"etEndSim\",\r\n                \"etStatus\"\r\n            ]\r\n        },\r\n        \"DistributionType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Optional. For event type of etDistribution this is the type of distribution the user selected.\",\r\n            \"enum\": [\r\n                \"dtNormal\",\r\n                \"dtExponential\",\r\n                \"dtWeibull\",\r\n                \"dtLogNormal\",\r\n                \"dtTriangular\",\r\n                \"dtGamma\",\r\n                \"dtGompertz\",\r\n                \"dtUniform\",\r\n                \"dtBeta\"\r\n            ]\r\n        },\r\n        \"GateType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Gate type for the logic node\",\r\n            \"enum\": [\r\n                \"gtAnd\",\r\n                \"gtOr\",\r\n                \"gtNot\"\r\n            ]\r\n        },\r\n        \"VarScope\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Context of use for the variable in the model.\",\r\n            \"enum\": [\r\n                \"gtDocLink\",\r\n                \"gtAccrual\",\r\n                \"gtGlobal\",\r\n                \"gt3DSim\"\r\n            ]\r\n        },\r\n        \"DocVarType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"If the varScope is gtDocLink then this the type of document the variable can be linked to. XML, JSON or PlainText using a regular expression\",\r\n            \"enum\": [\r\n                \"dtXML\",\r\n                \"dtJSON\",\r\n                \"dtTextRegEx\"\r\n            ]\r\n        },\r\n        \"VariableType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"This is the type of the variable, Bool, double, int, string\",\r\n            \"enum\": [\r\n                \"bool\",\r\n                \"double\",\r\n                \"int\",\r\n                \"string\"\r\n            ]\r\n        },\r\n        \"AccrualVarTableType\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"Type of accrual for the specified state.\",\r\n            \"enum\": [\r\n                \"ctMultiplier\",\r\n                \"ctTable\"\r\n            ]\r\n        },\r\n        \"StateEvalValue\": {\r\n            \"type\": \"string\",\r\n            \"description\": \"For single state diagrams. Boolean value for the diagram when evaluated in a logic tree. Ignore - removes that item from the logic calculation. \",\r\n            \"enum\": [\r\n                \"True\",\r\n                \"False\",\r\n                \"Ignore\"\r\n            ]\r\n        }\r\n    }\r\n}";
    // const schema = JSON.parse(schemaTxt);
    
    // const validator = new Validator();
    // const validationResult = validator.validate(newModel, schema);
    // if(validationResult.valid === false){
    //     validationResult.errors.forEach(error => {
    //         retModel.errors.push(error.instance + " - " + error.message + " : " + JSON.stringify(error.argument))
    //     });
    // }

    fetch(schemaPath)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to fetch schema text");
            }
            return response.text();
        })
        .then(schemaTxt => {
            const schema = JSON.parse(schemaTxt);
            const validator = new Validator();
            console.log(validator);
            const validationResult = validator.validate(newModel, schema);
            if (validationResult.valid === false) {
                validationResult.errors.forEach(error => {
                    retModel.errors.push(error.instance + " - " + error.message + " : " + JSON.stringify(error.argument))
                });
            }
        })
        .catch(error => {
            // handle error
            console.error(error);
        });

    return retModel;
}